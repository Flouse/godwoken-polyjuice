
#define GW_GENERATOR

#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "ckb_syscalls.h"

#include <ethash/keccak.hpp>
#include <evmc/evmc.h>

#include "common.h"
#include "gw_syscalls.h"
#include "sudt_utils.h"
#include "../generator/secp256k1_helper.h"
#include "../contracts.h"

evmc_address build_pre_compiled_contract_address(uint8_t n) {
  evmc_address addr{0};
  addr.bytes[19] = n;
  return addr;
}

void hex2bin(const char *hex, uint8_t **out, size_t *out_len) {
  size_t hex_length = strlen(hex);
  *out_len = hex_length / 2;
  *out = (uint8_t *)malloc(*out_len);
  char part1;
  char part2;
  for (size_t i = 0; i < *out_len; i++) {
    part1 = hex[i*2];
    part2 = hex[i*2 + 1];
    part1 = part1 >= 'a' ? (part1 - 'a' + 10) : (part1 >= 'A' ? (part1 - 'A' + 10) : (part1 - '0'));
    part2 = part2 >= 'a' ? (part2 - 'a' + 10) : (part2 >= 'A' ? (part2 - 'A' + 10) : (part2 - '0'));
    (*out)[i] = (uint8_t)(part1 * 16 + part2);
  }
}

int test_contract(const uint8_t n,
                  const char *input_hex,
                  const char *expected_output_hex,
                  const uint64_t expected_gas,
                  const char *success_message) {
  debug_print_int("pre-compiled contract address", n);
  int ret;
  evmc_address addr = build_pre_compiled_contract_address(n);
  precompiled_contract_gas_fn contract_gas = NULL;
  precompiled_contract_fn contract = NULL;
  if (!match_precompiled_address(&addr, &contract_gas, &contract)) {
    return -1;
  }
  uint8_t *input_src = NULL;
  size_t input_size = 0;
  hex2bin(input_hex, &input_src, &input_size);

  uint64_t gas = 0;
  if (contract_gas(input_src, input_size, &gas) != 0) {
    ckb_debug("calculate gas failed");
    return -1;
  }

  gw_context_t ctx;
  ctx.sys_load_data = sys_load_data;
  uint32_t from_id = 0xff;
  uint8_t *output = NULL;
  size_t output_size = 0;
  ret = contract(&ctx, from_id, input_src, input_size, &output, &output_size);
  if (ret != 0) {
    debug_print_int("run contract failed", ret);
    return ret;
  }
  ckb_debug("run contract success");

  if (gas != expected_gas) {
    ckb_debug("gas not matched");
    debug_print_int("got gas", gas);
    return -1;
  }
  ckb_debug("gas matched");

  uint8_t *expected_output = NULL;
  size_t expected_output_size = 0;
  hex2bin(expected_output_hex, &expected_output, &expected_output_size);
  if (expected_output_size != output_size) {
    debug_print_int("expected output size", expected_output_size);
    debug_print_int("returned output size", output_size);
    return -1;
  }
  if (memcmp(expected_output, output, output_size) != 0) {
    debug_print_data("expected output", expected_output, output_size);
    debug_print_data("returned output", output, output_size);
    return -1;
  }
  free(input_src);
  free(expected_output);
  free(output);
  ckb_debug(success_message);
  ckb_debug("===============================================");
  return 0;
}

int test_ecrecover() {
  if (test_contract(1,
                    "a8b53bdf3306a35a7103ab5504a0c9b492295564b6202b1942a84ef300107281000000000000000000000000000000000000000000000000000000000000001b307835653165303366353363653138623737326363623030393366663731663366353366356337356237346463623331613835616138623838393262346538621122334455667788991011121314151617181920212223242526272829303132",
                    "",
                    3000,
                    "ecrecover CallEcrecoverUnrecoverableKey ok") != -77) {
    return -1;
  }
  if (test_contract(1,
                    "18c547e4f7b0f325ad1e56f57e26c745b09a3e503d86e00e5255ff7f715d3d1c000000000000000000000000000000000000000000000000000000000000001c73b1693892219d736caba55bdb67216e485557ea6b6af75f37096c9aa6a5a75feeb940b1d03b21e36b0e47e79769f095fe2ab855bd91e3a38756b7d75a9c4549",
                    "000000000000000000000000a94f5374fce5edbc8e2a8697c15331677e6ebf0b",
                    3000,
                    "ecrecover ValidKey ok") != 0) {
    return -1;
  }
  if (test_contract(1,
                    "18c547e4f7b0f325ad1e56f57e26c745b09a3e503d86e00e5255ff7f715d3d1c100000000000000000000000000000000000000000000000000000000000001c73b1693892219d736caba55bdb67216e485557ea6b6af75f37096c9aa6a5a75feeb940b1d03b21e36b0e47e79769f095fe2ab855bd91e3a38756b7d75a9c4549",
                    "",
                    3000,
                    "ecrecover InvalidHighV-bits-1 ok") != -75) {
    return -1;
  }
  if (test_contract(1,
                    "18c547e4f7b0f325ad1e56f57e26c745b09a3e503d86e00e5255ff7f715d3d1c000000000000000000000000000000000000001000000000000000000000001c73b1693892219d736caba55bdb67216e485557ea6b6af75f37096c9aa6a5a75feeb940b1d03b21e36b0e47e79769f095fe2ab855bd91e3a38756b7d75a9c4549",
                    "",
                    3000,
                    "ecrecover InvalidHighV-bits-2 ok") != -75) {
    return -1;
  }
  if (test_contract(1,
                    "18c547e4f7b0f325ad1e56f57e26c745b09a3e503d86e00e5255ff7f715d3d1c000000000000000000000000000000000000001000000000000000000000011c73b1693892219d736caba55bdb67216e485557ea6b6af75f37096c9aa6a5a75feeb940b1d03b21e36b0e47e79769f095fe2ab855bd91e3a38756b7d75a9c4549",
                    "",
                    3000,
                    "ecrecover InvalidHighV-bits-3 ok") != -75) {
    return -1;
  }
  return 0;
}

int test_sha256hash() {
  if (test_contract(2,
                    "38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e000000000000000000000000000000000000000000000000000000000000001b38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e789d1dd423d25f0772d2748d60f7e4b81bb14d086eba8e8e8efb6dcff8a4ae02",
                    "811c7003375852fabd0d362e40e68607a12bdabae61a7d068fe5fdd1dbbf2a5d",
                    108,
                    "sha256hash ok") != 0) {
    return -1;
  }
  return 0;
}

int test_ripemd160hash() {
  if (test_contract(3,
                    "38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e000000000000000000000000000000000000000000000000000000000000001b38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e789d1dd423d25f0772d2748d60f7e4b81bb14d086eba8e8e8efb6dcff8a4ae02",
                    "0000000000000000000000009215b8d9882ff46f0dfde6684d78e831467f65e6",
                    1080,
                    "ripemd160hash ok") != 0) {
    return -1;
  }
  return 0;
}

int test_data_copy() {
  if (test_contract(4,
                    "38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e000000000000000000000000000000000000000000000000000000000000001b38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e789d1dd423d25f0772d2748d60f7e4b81bb14d086eba8e8e8efb6dcff8a4ae02",
                    "38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e000000000000000000000000000000000000000000000000000000000000001b38d18acb67d25c8bb9942764b62f18e17054f66a817bd4295423adf9ed98873e789d1dd423d25f0772d2748d60f7e4b81bb14d086eba8e8e8efb6dcff8a4ae02",
                    27,
                    "dataCopy ok") != 0) {
    return -1;
  }
  return 0;
}

int test_big_mod_exp() {
  if (test_contract(5,
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002003fffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2efffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f",
                    "0000000000000000000000000000000000000000000000000000000000000001",
                    13056,
                    "bigModExp eip_example1 ok") != 0) {
    return -1;
  }
  if (test_contract(5,
                    "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020fffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2efffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f",
                    "0000000000000000000000000000000000000000000000000000000000000000",
                    13056,
                    "bigModExp eip_example2 ok") != 0) {
    return -1;
  }
  return 0;
}

int test_bn256_add_istanbul() {
  if (test_contract(6,
                    "18b18acfb4c2c30276db5411368e7185b311dd124691610c5d3b74034e093dc9063c909c4720840cb5134cb9f59fa749755796819658d32efc0d288198f3726607c2b7f58a84bd6145f00c9c2bc0bb1a187f20ff2c92963a88019e7c6a014eed06614e20c147e940f2d70da3f74c9a17df361706a4485c742bd6788478fa17d7",
                    "2243525c5efd4b9c3d3c45ac0ca3fe4dd85e830a4ce6b65fa1eeaee202839703301d1d33be6da8e509df21cc35964723180eed7532537db9ae5e7d48f195c915",
                    150,
                    "chfast1 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "2243525c5efd4b9c3d3c45ac0ca3fe4dd85e830a4ce6b65fa1eeaee202839703301d1d33be6da8e509df21cc35964723180eed7532537db9ae5e7d48f195c91518b18acfb4c2c30276db5411368e7185b311dd124691610c5d3b74034e093dc9063c909c4720840cb5134cb9f59fa749755796819658d32efc0d288198f37266",
                    "2bd3e6d0f3b142924f5ca7b49ce5b9d54c4703d7ae5648e61d02268b1a0a9fb721611ce0a6af85915e2f1d70300909ce2e49dfad4a4619c8390cae66cefdb204",
                    150,
                    "chfast2 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio1 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio2 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio3 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio4 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio5 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio6 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio7 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio8 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio9 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio10 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    "030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd315ed738c0e0a7c92e7845f96b2ae9c0a68a6a449e3538fc7ff3ebf7a5a18a2c4",
                    150,
                    "cdetrio11 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd315ed738c0e0a7c92e7845f96b2ae9c0a68a6a449e3538fc7ff3ebf7a5a18a2c4",
                    150,
                    "cdetrio12 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d98",
                    "15bf2bb17880144b5d1cd2b1f46eff9d617bffd1ca57c37fb5a49bd84e53cf66049c797f9ce0d17083deb32b5e36f2ea2a212ee036598dd7624c168993d1355f",
                    150,
                    "cdetrio13 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa92e83f8d734803fc370eba25ed1f6b8768bd6d83887b87165fc2434fe11a830cb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio14 ok") != 0) {
    return -1;
  }

  return 0;
}

int test_bn256_scalar_mul_istanbul() {
  if (test_contract(7,
                    "2bd3e6d0f3b142924f5ca7b49ce5b9d54c4703d7ae5648e61d02268b1a0a9fb721611ce0a6af85915e2f1d70300909ce2e49dfad4a4619c8390cae66cefdb20400000000000000000000000000000000000000000000000011138ce750fa15c2",
                    "070a8d6a982153cae4be29d434e8faef8a47b274a053f5a4ee2a6c9c13c31e5c031b8ce914eba3a9ffb989f9cdd5b0f01943074bf4f0f315690ec3cec6981afc",
                    6000,
                    "bn256ScalarMulIstanbul chfast1 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "070a8d6a982153cae4be29d434e8faef8a47b274a053f5a4ee2a6c9c13c31e5c031b8ce914eba3a9ffb989f9cdd5b0f01943074bf4f0f315690ec3cec6981afc30644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd46",
                    "025a6f4181d2b4ea8b724290ffb40156eb0adb514c688556eb79cdea0752c2bb2eff3f31dea215f1eb86023a133a996eb6300b44da664d64251d05381bb8a02e",
                    6000,
                    "bn256ScalarMulIstanbul chfast2 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "025a6f4181d2b4ea8b724290ffb40156eb0adb514c688556eb79cdea0752c2bb2eff3f31dea215f1eb86023a133a996eb6300b44da664d64251d05381bb8a02e183227397098d014dc2822db40c0ac2ecbc0b548b438e5469e10460b6c3e7ea3",
                    "14789d0d4a730b354403b5fac948113739e276c23e0258d8596ee72f9cd9d3230af18a63153e0ec25ff9f2951dd3fa90ed0197bfef6e2a1a62b5095b9d2b4a27",
                    6000,
                    "bn256ScalarMulIstanbul chfast3 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f6ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
                    "2cde5879ba6f13c0b5aa4ef627f159a3347df9722efce88a9afbb20b763b4c411aa7e43076f6aee272755a7f9b84832e71559ba0d2e0b17d5f9f01755e5b0d11",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio1 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f630644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000000",
                    "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe3163511ddc1c3f25d396745388200081287b3fd1472d8339d5fecb2eae0830451",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio2 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f60000000000000000000000000000000100000000000000000000000000000000",
                    "1051acb0700ec6d42a88215852d582efbaef31529b6fcbc3277b5c1b300f5cf0135b2394bb45ab04b8bd7611bd2dfe1de6a4e6e2ccea1ea1955f577cd66af85b",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio3 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f60000000000000000000000000000000000000000000000000000000000000009",
                    "1dbad7d39dbc56379f78fac1bca147dc8e66de1b9d183c7b167351bfe0aeab742cd757d51289cd8dbd0acf9e673ad67d0f0a89f912af47ed1be53664f5692575",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio4 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f60000000000000000000000000000000000000000000000000000000000000001",
                    "1a87b0584ce92f4593d161480614f2989035225609f08058ccfa3d0f940febe31a2f3c951f6dadcc7ee9007dff81504b0fcd6d7cf59996efdc33d92bf7f9f8f6",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio5 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7cffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
                    "29e587aadd7c06722aabba753017c093f70ba7eb1f1c0104ec0564e7e3e21f6022b1143f6a41008e7755c71c3d00b6b915d386de21783ef590486d8afa8453b1",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio6 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c30644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000000",
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa92e83f8d734803fc370eba25ed1f6b8768bd6d83887b87165fc2434fe11a830cb",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio7 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c0000000000000000000000000000000100000000000000000000000000000000",
                    "221a3577763877920d0d14a91cd59b9479f83b87a653bb41f82a3f6f120cea7c2752c7f64cdd7f0e494bff7b60419f242210f2026ed2ec70f89f78a4c56a1f15",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio8 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c0000000000000000000000000000000000000000000000000000000000000009",
                    "228e687a379ba154554040f8821f4e41ee2be287c201aa9c3bc02c9dd12f1e691e0fd6ee672d04cfd924ed8fdc7ba5f2d06c53c1edc30f65f2af5a5b97f0a76a",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio9 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c0000000000000000000000000000000000000000000000000000000000000001",
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio10 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d98ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",
                    "00a1a234d08efaa2616607e31eca1980128b00b415c845ff25bba3afcb81dc00242077290ed33906aeb8e42fd98c41bcb9057ba03421af3f2d08cfc441186024",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio11 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d9830644e72e131a029b85045b68181585d2833e84879b9709143e1f593f0000000",
                    "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b8692929ee761a352600f54921df9bf472e66217e7bb0cee9032e00acc86b3c8bfaf",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio12 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d980000000000000000000000000000000100000000000000000000000000000000",
                    "1071b63011e8c222c5a771dfa03c2e11aac9666dd097f2c620852c3951a4376a2f46fe2f73e1cf310a168d56baa5575a8319389d7bfa6b29ee2d908305791434",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio13 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d980000000000000000000000000000000000000000000000000000000000000009",
                    "19f75b9dd68c080a688774a6213f131e3052bd353a304a189d7a2ee367e3c2582612f545fb9fc89fde80fd81c68fc7dcb27fea5fc124eeda69433cf5c46d2d7f",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio14 ok") != 0) {
    return -1;
  }
  if (test_contract(7,
                    "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d980000000000000000000000000000000000000000000000000000000000000001",
                    "039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d98",
                    6000,
                    "bn256ScalarMulIstanbul cdetrio15 ok") != 0) {
    return -1;
  }
  return 0;
}

int test_blake2f() {
  /* error cases */
  if (test_contract(9,
                    "",
                    "[error]",
                    0,
                    "blake2F vector 0: empty input") != ERROR_BLAKE2F_INVALID_INPUT_LENGTH) {
    return -1;
  }
  if (test_contract(9,
                    "00000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001",
                    "[error]",
                    0,
                    "blake2F vector 1: less than 213 bytes input") != ERROR_BLAKE2F_INVALID_INPUT_LENGTH) {
    return -1;
  }
  if (test_contract(9,
                    "000000000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001",
                    "[error]",
                    0,
                    "blake2F vector 2: more than 213 bytes input") != ERROR_BLAKE2F_INVALID_INPUT_LENGTH) {
    return -1;
  }
  if (test_contract(9,
                    "0000000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000002",
                    "[error]",
                    0,
                    "blake2F vector 3: malformed final block indicator flag") != ERROR_BLAKE2F_INVALID_FINAL_FLAG) {
    return -1;
  }

  /* success cases */
  if (test_contract(9,
                    "0000000048c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001",
                    "08c9bcf367e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d282e6ad7f520e511f6c3e2b8c68059b9442be0454267ce079217e1319cde05b",
                    0,
                    "blake2F vector 4") != 0) {
    return -1;
  }
  if (test_contract(9,
                    "0000000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001",
                    "ba80a53f981c4d0d6a2797b69f12f6e94c212f14685ac4b74b12bb6fdbffa2d17d87c5392aab792dc252d5de4533cc9518d38aa8dbf1925ab92386edd4009923",
                    12,
                    "blake2F vector 5") != 0) {
    return -1;
  }
  if (test_contract(9,
                    "0000000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000",
                    "75ab69d3190a562c51aef8d88f1c2775876944407270c42c9844252c26d2875298743e7f6d5ea2f2d3e8d226039cd31b4e426ac4f2d3d666a610c2116fde4735",
                    12,
                    "blake2F vector 6") != 0) {
    return -1;
  }
  if (test_contract(9,
                    "0000000148c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001",
                    "b63a380cb2897d521994a85234ee2c181b5f844d2c624c002677e9703449d2fba551b3a8333bcdf5f2f7e08993d53923de3d64fcc68c034e717b9293fed7a421",
                    1,
                    "blake2F vector 7") != 0) {
    return -1;
  }
  if (test_contract(9,
                    "007A120048c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001",
                    "6d2ce9e534d50e18ff866ae92d70cceba79bbcd14c63819fe48752c8aca87a4bb7dcc230d22a4047f0486cfcfb50a17b24b2899eb8fca370f22240adb5170189",
                    8000000,
                    "blake2F vector 8") != 0) {
    return -1;
  }
  return 0;
}

int main() {
  if (test_ecrecover() != 0) {
    return -1;
  }
  if (test_sha256hash() != 0) {
    return -2;
  }
  if (test_ripemd160hash() != 0) {
    return -3;
  }
  if (test_data_copy() != 0) {
    return -4;
  }
  if (test_big_mod_exp() != 0) {
    return -5;
  }
  if (test_bn256_add_istanbul() != 0) {
    return -6;
  }
  if (test_bn256_scalar_mul_istanbul() != 0) {
    return -7;
  }
  if (test_blake2f() != 0) {
    return -9;
  }
  return 0;
}
