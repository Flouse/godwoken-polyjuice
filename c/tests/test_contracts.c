
#define GW_GENERATOR

#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "ckb_syscalls.h"

#include <ethash/keccak.hpp>
#include <evmc/evmc.h>

#include "common.h"
#include "gw_syscalls.h"
#include "sudt_utils.h"
#include "../generator/secp256k1_helper.h"
#include "../contracts.h"

evmc_address build_pre_compiled_contract_address(uint8_t n) {
  evmc_address addr{0};
  addr.bytes[19] = n;
  return addr;
}

void hex2bin(const char *hex, uint8_t **out, size_t *out_len) {
  size_t hex_length = strlen(hex);
  ckb_debug(hex);
  debug_print_int("hex length", hex_length);
  *out_len = hex_length / 2;
  *out = (uint8_t *)malloc(*out_len);
  char part1;
  char part2;
  for (size_t i = 0; i < *out_len; i++) {
    part1 = hex[i*2];
    part2 = hex[i*2 + 1];
    part1 = part1 >= 'a' ? (part1 - 'a' + 10) : (part1 - '0');
    part2 = part2 >= 'a' ? (part2 - 'a' + 10) : (part2 - '0');
    (*out)[i] = (uint8_t)(part1 * 16 + part2);
  }
}

int test_contract(const uint8_t n,
                  const char *input_hex,
                  const char *expected_output_hex,
                  const uint64_t expected_gas,
                  const char *success_message) {
  evmc_address addr = build_pre_compiled_contract_address(n);
  precompiled_contract_gas_fn contract_gas = NULL;
  precompiled_contract_fn contract = NULL;
  if (!match_precompiled_address(&addr, &contract_gas, &contract)) {
    return -1;
  }
  uint8_t *input_src = NULL;
  size_t input_size = 0;
  hex2bin(input_hex, &input_src, &input_size);

  uint64_t gas = 0;
  if (contract_gas(input_src, input_size, &gas) != 0) {
    return -1;
  }
  if (gas != expected_gas) {
    return -1;
  }
  ckb_debug("gas matched");

  gw_context_t* ctx = NULL;
  uint32_t from_id = 0xff;
  uint8_t *output = NULL;
  size_t output_size = 0;
  if (contract(ctx, from_id, input_src, input_size, &output, &output_size) != 0) {
    return -1;
  }
  ckb_debug("run contract success");
  uint8_t *expected_output = NULL;
  size_t expected_output_size = 0;
  hex2bin(expected_output_hex, &expected_output, &expected_output_size);
  if (expected_output_size != output_size) {
    debug_print_int("expected output size", expected_output_size);
    debug_print_int("returned output size", output_size);
    return -1;
  }
  if (memcmp(expected_output, output, output_size) != 0) {
    debug_print_data("expected output", expected_output, output_size);
    debug_print_data("returned output", output, output_size);
    return -1;
  }
  free(input_src);
  free(expected_output);
  free(output);
  ckb_debug(success_message);
  ckb_debug("===============================================");
  return 0;
}

int test_bn256_add_istanbul() {
  if (test_contract(6,
                    "18b18acfb4c2c30276db5411368e7185b311dd124691610c5d3b74034e093dc9063c909c4720840cb5134cb9f59fa749755796819658d32efc0d288198f3726607c2b7f58a84bd6145f00c9c2bc0bb1a187f20ff2c92963a88019e7c6a014eed06614e20c147e940f2d70da3f74c9a17df361706a4485c742bd6788478fa17d7",
                    "2243525c5efd4b9c3d3c45ac0ca3fe4dd85e830a4ce6b65fa1eeaee202839703301d1d33be6da8e509df21cc35964723180eed7532537db9ae5e7d48f195c915",
                    150,
                    "chfast1 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "2243525c5efd4b9c3d3c45ac0ca3fe4dd85e830a4ce6b65fa1eeaee202839703301d1d33be6da8e509df21cc35964723180eed7532537db9ae5e7d48f195c91518b18acfb4c2c30276db5411368e7185b311dd124691610c5d3b74034e093dc9063c909c4720840cb5134cb9f59fa749755796819658d32efc0d288198f37266",
                    "2bd3e6d0f3b142924f5ca7b49ce5b9d54c4703d7ae5648e61d02268b1a0a9fb721611ce0a6af85915e2f1d70300909ce2e49dfad4a4619c8390cae66cefdb204",
                    150,
                    "chfast2 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio1 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio2 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio3 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio4 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio5 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio6 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio7 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio8 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio9 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    150,
                    "cdetrio10 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002",
                    "030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd315ed738c0e0a7c92e7845f96b2ae9c0a68a6a449e3538fc7ff3ebf7a5a18a2c4",
                    150,
                    "cdetrio11 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "030644e72e131a029b85045b68181585d97816a916871ca8d3c208c16d87cfd315ed738c0e0a7c92e7845f96b2ae9c0a68a6a449e3538fc7ff3ebf7a5a18a2c4",
                    150,
                    "cdetrio12 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c039730ea8dff1254c0fee9c0ea777d29a9c710b7e616683f194f18c43b43b869073a5ffcc6fc7a28c30723d6e58ce577356982d65b833a5a5c15bf9024b43d98",
                    "15bf2bb17880144b5d1cd2b1f46eff9d617bffd1ca57c37fb5a49bd84e53cf66049c797f9ce0d17083deb32b5e36f2ea2a212ee036598dd7624c168993d1355f",
                    150,
                    "cdetrio13 ok") != 0) {
    return -1;
  }
  if (test_contract(6,
                    "17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa901e0559bacb160664764a357af8a9fe70baa9258e0b959273ffc5718c6d4cc7c17c139df0efee0f766bc0204762b774362e4ded88953a39ce849a8a7fa163fa92e83f8d734803fc370eba25ed1f6b8768bd6d83887b87165fc2434fe11a830cb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                    150,
                    "cdetrio14 ok") != 0) {
    return -1;
  }

  return 0;
}

int main() {
  if (test_bn256_add_istanbul() != 0) {
    return -6;
  }
  return 0;
}
